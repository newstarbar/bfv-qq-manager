## 🌟 BFV 二代服管机使用指南

### 一、功能简介

BFV 二代服管机是升级后的服务器管理工具，支持权限控制、服务器管理、自动播报等功能，可通过 QQ 机器人操作，详细功能见项目 README。

### 二、前置环境准备

#### 1. 配置 napcat（必做）

BFV 二代服管机依赖 napcat 框架，需先完成配置。

-   **什么是 napcat**：一款基于 NTQQ 的 Bot 协议工具，无需图形界面，在 Linux 上性能好，占用内存低。
-   **获取与安装**：
    -   项目地址：[NapNeko/NapCatQQ](https://github.com/NapNeko/NapCatQQ)
    -   官方文档：[NapCat 官方文档](https://napneko.github.io)（含详细安装步骤）
    -   Windows 用户：直接下载[一键安装包](https://github.com/NapNeko/NapCatQQ/releases/latest/download/napcat.shell.windows.onekey.zip)，解压后运行 `napcat installer.exe`，自动完成安装。
-   **关键配置**：  
    确保 BFV 配置文件中的以下参数与 napcat 一致（默认值通常无需修改，特殊情况需对应调整）：
    ```json
    {
    	"ws_ip": "127.0.0.1:3001", // 与napcat的ws地址一致
    	"ws_token": "napcat", // 与napcat的ws令牌一致
    	"http_ip": "127.0.0.1:3000", // 与napcat的http地址一致
    	"http_token": "napcat" // 与napcat的http令牌一致
    }
    ```
-   **注意**：严格按官方文档操作，配置错误会导致服管机无法运行，问题可参考文档 FAQ 或项目讨论区。

#### 2. 绑定 BFV ROBOT 社区平台（必做）

需绑定 QQ、KOOK、QQ Open ID 才能正常使用部分功能。

-   **详细教程**：[BFV ROBOT 社区绑定指南](https://zth.ink/?p=558)
-   **快速绑定步骤**：
    -   **QQ 绑定**：通过[官方教程](https://forum.bfvrobot.net/t/topic/625)，用 QQ 邮箱验证（点击绑定按钮 → 完成人机验证 → 邮箱点击链接）。
    -   **QQ Open ID 绑定**：
        1. 私聊 RunRun 机器人（官方指定），发送 `/bind` 获取 Open ID；
        2. 登录 ROBOT 官网，在个人中心填写 Open ID 并完成验证；
        3. 回到 RunRun 机器人对话框，发送 `/bindVerify` 完成绑定。

### 三、下载与安装步骤

1. **下载依赖**：  
   下载[V2 前置环境依赖](https://github.com/newstarbar/bfv-qq-manager/releases/tag/v2)，根据系统选择：

    - Windows：[Win-Configure.zip](https://github.com/newstarbar/bfv-qq-manager/releases/download/v2/Win-Configure.zip)
    - Linux：[Linux-Configure.tar](https://github.com/newstarbar/bfv-qq-manager/releases/download/v2/Linux-Configure.tar)  
      解压到同一个文件夹（后续程序都放这里）。

2. **下载主程序**：  
   下载最新版 `bfv-manager-win.exe`（Windows）或 `bfv-manager-linux.sh`（Linux），放入上述文件夹。

3. **下载数据统计程序**：  
   下载 `data-statistics-win.exe`（Windows）或 `data-statistics-linux.sh`（Linux），放入同一文件夹。

    - 建议：`bfv-manager` 放国内服务器，`data-statistics` 放国外服务器。

4. **启动程序**：

    - 先运行 `bfv-manager` 启动服管机；
    - 再运行 `data-statistics` 启动数据统计（若不在同一台机器，需修改配置文件的 `data_statistics_ip`，并运行[端口开放脚本](https://github.com/newstarbar/bfv-qq-manager/blob/main/doc/开启dataStatistics服务端口.bat)，云服务器需在安全组开放 7639 端口）。

5. 按提示完成配置，等待启动完成。

### 四、环境配置细节

#### 1. 生图模块部署

-   把 `chrome.zip` 放到程序同级文件夹，解压后确保目录结构如下：
    ```
    BFVQQ服管系统.exe
    chrome/
    └── win/
        └── chrome.exe
    ```
-   注意：此文件夹无需随版本更新改动。

#### 2. 核心配置文件修改

找到程序同级的 `config.json`（或类似名称），按说明填写：

```json
{
	"status_ip": "127.0.0.1:7639", // 战绩查询接口（默认不变）
	"status_token": "zygo", // 接口令牌（外部部署需修改，注意保密）
	"ws_ip": "127.0.0.1:3001", // 勿改，与napcat对应
	"ws_token": "napcat", // 勿改，与napcat一致
	"http_ip": "127.0.0.1:3000", // 勿改，与napcat对应
	"http_token": "napcat", // 勿改，与napcat一致
	"bot_name": "服管机器人", // 机器人昵称（踢人时显示）
	"bot_qq": "", // 填写机器人QQ号（需验证）
	"admin_qq": "", // 超级管理员QQ号（必填，用于初始化群聊）
	"group_name": "", // 群组名称（需验证）
	"ai_token": "", // AI模块token（获取：https://cloud.siliconflow.cn/i/wIXurGHa）
	"ai_model": "Qwen/Qwen2.5-7B-Instruct" // AI模型名称（获取：https://cloud.siliconflow.cn/me/models）
}
```

### 五、初次使用流程

1. **初始化群聊**  
   在群内发送 `init` 命令，完成群聊初始化。

2. **刷新群成员权限**  
   发送 `update` 命令，自动按头衔分配权限：

    - 头衔含「督战队」→ 1 级管理员
    - 头衔含「都督」→ 2 级管理员
    - 头衔含「总督」「群主」「服主」→ 3 级管理员
    - 配置文件中 `admin_qq` 对应账号 → 4 级超级管理员（唯一）

3. **手动设置管理员**  
   发送 `admin=QQ号 权限等级`（例如 `admin=123456 1`），设置后需再发 `update` 生效。

4. **Cookie 管理**

    - 超管绑定他人 Cookie：发送 `cookie=EAID QQ号 SID`
    - 管理员更新自身 Cookie：私聊机器人发送 `sid=具体Cookie[SID]`
    - Cookie 过期时，机器人会私聊提醒。

5. **设置 EA 查询主账号**  
   发送 `main=EAID` 指定主账号（⚠️ 强烈建议用开通 EA 密钥的红信账号，降低封禁风险）。

6. **配置服务器武器限制** - 参考[示例配置](https://github.com/newstarbar/bfv-qq-manager/blob/main/doc/check_config.json)
    - 该文件需放置`config.json`同级目录, 名称为`check_config.json`
    - 每个服务器单独配置：
    - `server_name`：服务器中文名称（需完全一致）
    - `ban_list`：禁用武器列表
    - `name`：禁用武器名称
    - `start_time`：禁用开始时间
    - `end_time`：禁用结束时间
    - 时间严格遵守 `HH-MM` 24 小时制，如 00-00 为凌晨 0 点，23-59 为深夜 12 点，既全天禁用。

### 六、重要风险提示

-   程序调用频率较高，**主 EA 查询账号可能被 EA 封禁**，请谨慎选择账号。
-   推荐用开通 EA 密钥的红信账号作为主查询账号，勿用个人常用账号。
-   账号封禁风险由用户自行承担，非主查询账号的 Cookie 仅用于播报，风险较低。
