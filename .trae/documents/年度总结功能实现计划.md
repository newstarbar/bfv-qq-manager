# 年度总结功能实现计划

## 一、实现目标

1. 编写 `annualSummary.ts` 文件，实现获取服务器和玩家年度数据的功能
2. 在 `generateBase64Image.ts` 中添加新的函数，用于生成年度总结图片
3. 支持 `playerAnnualSummary.html` 和 `serverAnnualSummary.html` 页面的绘制

## 二、实现步骤

### 1. 编写 `annualSummary.ts` 文件

**核心功能**：实现服务器和玩家年度数据的查询

**文件结构**：
```typescript
// 导入依赖
import { SQLiteDB } from '../../utils/sqlite';
import path from 'path';

// 数据库连接配置
const ONLINE_HISTORY_DB = path.join(process.cwd(), 'data', 'onlineHistory.db');
const PLAYER_DETAILS_DB = path.join(process.cwd(), 'data', 'playerDetails.db');
const WARM_PLAYER_DB = path.join(process.cwd(), 'data', 'warmPlayer.db');

// 创建表SQL
const CREATE_TABLE_SQL = 'CREATE TABLE IF NOT EXISTS temp (id INTEGER PRIMARY KEY)';

// 服务器维度数据查询函数
export async function getServerAnnualData(serverName: string, year: number) {
    // 1. 查询暖服总次数
    // 2. 查询暖服次数最多的玩家
    // 返回服务器年度数据
}

// 玩家维度数据查询函数
export async function getPlayerAnnualData(playerName: string, year: number) {
    // 3. 查询总击杀数
    // 4. 查询助攻数
    // 5. 查询爆头数
    // 6. 查询救人数
    // 7. 查询治疗量
    // 8. 查询胜场/负场
    // 9. 查询游戏时长
    // 10. 查询胜率
    // 11. 查询KD比
    // 12. 查询总得分
    // 13. 查询最喜爱武器
    // 14. 查询最喜爱载具
    // 15. 查询最喜爱 gadgets
    // 返回玩家年度数据
}

// onlineHistory表查询函数
export async function getPlayerOnlineHistory(playerName: string, year: number) {
    // 查询玩家在线天数、场次、时长
    // 返回相关数据
}
```

### 2. 修改 `generateBase64Image.ts` 文件

**核心功能**：添加生成年度总结图片的函数

**新增函数**：
```typescript
// 生成玩家年度总结图片
export async function generatePlayerAnnualSummaryImage(playerName: string, year: number, playerData: any): Promise<string> {
    // 读取playerAnnualSummary.html模板
    // 使用ejs渲染模板
    // 生成base64图片
}

// 生成服务器年度总结图片
export async function generateServerAnnualSummaryImage(serverName: string, year: number, serverData: any): Promise<string> {
    // 读取serverAnnualSummary.html模板
    // 使用ejs渲染模板
    // 生成base64图片
}
```

## 三、技术要点

1. **数据库连接管理**：使用现有的SQLiteDB类，确保连接正确关闭
2. **SQL查询实现**：将用户提供的SQL查询转换为TypeScript函数
3. **数据类型处理**：确保查询结果的数值类型正确
4. **模板引擎使用**：复用现有的ejs模板引擎
5. **代码复用**：复用现有的htmlToBase64Image函数

## 四、预期结果

1. 成功生成玩家年度总结图片，包含16项玩家数据
2. 成功生成服务器年度总结图片，包含服务器维度数据
3. 代码结构清晰，符合项目现有代码风格
4. 无编译错误，能正常运行

## 五、实现细节

### 1. annualSummary.ts 实现细节

- 遵循项目现有的数据库操作模式：打开-查询-关闭
- 使用参数化查询，防止SQL注入
- 处理查询结果，返回结构化数据
- 支持不同年份的查询

### 2. generateBase64Image.ts 实现细节

- 复用现有的htmlToBase64Image函数
- 使用ejs模板引擎渲染HTML
- 支持动态替换模板变量
- 处理图片生成过程中的异常

## 六、文件修改清单

1. `src/robot/cx/annualSummary.ts`：新增文件，实现年度数据查询功能
2. `src/qq/generateBase64Image.ts`：修改文件，添加年度总结图片生成函数

## 七、测试计划

1. 测试服务器年度数据查询功能
2. 测试玩家年度数据查询功能
3. 测试图片生成功能
4. 验证HTML页面渲染效果

## 八、后续工作

1. 优化查询性能，减少数据库连接次数
2. 添加错误处理，提高代码健壮性
3. 根据实际需求调整HTML模板样式
4. 测试不同数据情况下的页面渲染效果